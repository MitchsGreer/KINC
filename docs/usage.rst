Usage
=====

KINC provides two executables: ``kinc``, the command-line version, and ``qkinc``, the GUI version. The command-line version can use MPI while the GUI version can display data object files that are produced by KINC. KINC can construct a gene-coexpression network in the following steps:

1. ``import-emx``: Import expression matrix text file into binary format
2. ``similarity``: Compute a cluster matrix and correlation matrix from expression matrix
3. ``threshold``: Determine an appropriate correlation threshold for correlation matrix
4. ``extract``: Extract an edge list from a correlation matrix given a threshold

The easiest way to learn how to use KINC is to study the ``kinc.sh`` script, which can run the entire KINC workflow. Additionally, you can use the ``make-input-data.py`` script to generate a "fake" GEM with which to test KINC quickly:

.. code:: bash

   # generate fake GEM
   python scripts/make-input-data.py

   # run KINC
   scripts/kinc.sh serial 1 GEM.txt

Another recommended option is to use the `KINC-nf <https://github.com/SystemsGenetics/KINC-nf.git>`__ nextflow pipeline, which can run the entire KINC workflow on nearly any computing environment.

High Performance clusters
-------------------------

Palmetto
~~~~~~~~

Ensure the GEM you intend to process is in the correct format, read as a ``.txt`` file. Run the following command:

.. code:: bash

   cp /zfs/feltus/btsheal/kinc-cpu.sh $HOME
   cp /zfs/feltus/btsheal/kinc-gpu.sh $HOME

These two scripts, ``kinc-cpu.sh`` and ``kinc-gpu.sh``, are two ways to run KINC end-to-end, one with CPUs and one with GPUs. You can use either one according to your needs.

Each script takes a plaintext GEM file, and outputs the following:

- ``.emx``: expression matrix
- ``.ccm``: cluster composition matrix
- ``.cmx``: correlation matrix
- ``-rmt.log``: the log file, containing the threshold value generated by rmt
- ``.o*``: the job output file, check for errors at runtime
- ``-net.txt``: the network file, the product of KINC

You only need one of these scripts and your GEM file to run KINC. However, you must modify the ``kinc-*.sh`` script to use your GEM file and run the analytics that you want:

.. code:: bash

   # define input file
   INFILE="Yeast.txt"

   # define which analytics to run
   RUN_IMPORT_EMX=1
   RUN_SIMILARITY=1
   RUN_EXPORT_CMX=0
   RUN_THRESHOLD=0
   RUN_EXTRACT=0

More detailed instructions are provided in the scripts themselves.

The script will use scratch storage automatically, so it is recommended that you launch your jobs from your home directory so that all output files are automatically saved to your home directory instead of scratch:

.. code:: bash

   qsub kinc-cpu.sh

Once the job has finished, all output files should be in the directory where you ran ``qsub``. Check the last line of the log file to see the final threshold value, and check the output file to ensure there are no errors.

The resulting network file can be visualized using `BioDepVis <https://github.com/SystemsGenetics/BioDepVis.git>`__ or Cytoscape.

SLURM
~~~~~

Although KINC is an MPI application, generally you can run ``kinc`` as a stand-alone application without ``mpirun`` and achieve normal serial behavior. However, on a SLURM cluster where MPI jobs must be run with the ``srun`` command and where PMI2 is compiled into MPI, ``kinc`` cannot be executed stand-alone. It must be executed using ``srun`` with the additional argument ``--mpi=pmi2``. For example:

.. code:: bash

   srun --mpi=pmi2 kinc run import-emx --input Yeast.txt --output Yeast.emx --nan NA
